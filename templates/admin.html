{% extends "base.html" %}

{% block title %}Admin Dashboard - AutoMarket{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cog me-2 text-primary"></i>Admin Dashboard</h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                    <i class="fas fa-plus me-1"></i>Add New Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Vehicles</h5>
                    <h2 class="text-primary" id="total-count">{{ vehicles|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Available</h5>
                    <h2 class="text-success" id="available-count">{{ vehicles|selectattr("status", "equalto", "available")|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Sold</h5>
                    <h2 class="text-danger" id="sold-count">{{ vehicles|selectattr("status", "equalto", "sold")|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Categories</h5>
                    <h2 class="text-info">3</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicles Management Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-car me-2"></i>Vehicle Management</h5>
        </div>
        <div class="card-body">
            <div id="vehicles-container">
                {% if vehicles %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="vehicles-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Vehicle</th>
                                    <th>Category</th>
                                    <th>Year</th>
                                    <th>Price</th>
                                    <th>Mileage</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicles-tbody">
                                {% for vehicle in vehicles %}
                                    <tr id="vehicle-{{ vehicle.id }}">
                                        <td>
                                            {% if vehicle.images %}
                                                <div class="position-relative">
                                                    <img src="{{ url_for('static', filename='uploads/' + vehicle.images[0]) }}" 
                                                         class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover;" 
                                                         alt="{{ vehicle.title }}">
                                                    {% if vehicle.images|length > 1 %}
                                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary" style="font-size: 10px;">
                                                            {{ vehicle.images|length }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <div class="bg-secondary d-flex align-items-center justify-content-center" 
                                                     style="width: 60px; height: 45px;">
                                                    <i class="fas fa-car text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ vehicle.title }}</strong><br>
                                            <small class="text-muted">{{ vehicle.make }} {{ vehicle.model }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ vehicle.category }}</span>
                                        </td>
                                        <td>{{ vehicle.year }}</td>
                                        <td class="text-success">
                                            <strong>${{ "{:,.0f}".format(vehicle.price) }}</strong>
                                        </td>
                                        <td>{{ "{:,}".format(vehicle.mileage) }} mi</td>
                                        <td>
                                            {% if vehicle.status == 'available' %}
                                                <span class="badge bg-success status-badge">Available</span>
                                            {% else %}
                                                <span class="badge bg-danger status-badge">Sold</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ url_for('vehicle_detail', vehicle_id=vehicle.id) }}" 
                                                   class="btn btn-outline-info" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-warning" title="Edit"
                                                        onclick="openEditModal('{{ vehicle.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" title="Toggle Status"
                                                        onclick="toggleStatus('{{ vehicle.id }}')">
                                                    <i class="fas fa-exchange-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" title="Delete"
                                                        onclick="deleteVehicle('{{ vehicle.id }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4" id="empty-state">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No vehicles listed yet</h4>
                        <p class="text-muted">Start by adding your first vehicle to the inventory.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                            <i class="fas fa-plus me-1"></i>Add First Vehicle
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleModalTitle">Add New Vehicle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="vehicleForm" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div id="form-errors" class="alert alert-danger" style="display: none;"></div>
                    
                    <!-- Tabbed Interface for Better Organization -->
                    <ul class="nav nav-tabs" id="vehicleTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">Basic Info</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="engine-tab" data-bs-toggle="tab" data-bs-target="#engine" type="button" role="tab">Engine & Performance</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ownership-tab" data-bs-toggle="tab" data-bs-target="#ownership" type="button" role="tab">Ownership & History</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="insurance-tab" data-bs-toggle="tab" data-bs-target="#insurance" type="button" role="tab">Insurance & Docs</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab">Features & Condition <small class="text-muted">(Optional)</small></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">Contact & Images</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="vehicleTabContent">
                        <!-- Basic Information Tab -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control", id="modal-title") }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            {{ form.category.label(class="form-label") }}
                            {{ form.category(class="form-select", id="modal-category") }}
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.make.label(class="form-label") }}
                            {{ form.make(class="form-control", id="modal-make") }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            {{ form.model.label(class="form-label") }}
                            {{ form.model(class="form-control", id="modal-model") }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            {{ form.year.label(class="form-label") }}
                            {{ form.year(class="form-control", id="modal-year") }}
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.price.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.price(class="form-control", id="modal-price") }}
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.mileage.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.mileage(class="form-control", id="modal-mileage") }}
                                <span class="input-group-text">miles</span>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="3", id="modal-description") }}
                        <div class="invalid-feedback"></div>
                    </div>
                    
                            <div class="mb-3" id="status-field" style="display: none;">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select", id="modal-status") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- Engine & Performance Tab -->
                        <div class="tab-pane fade" id="engine" role="tabpanel" aria-labelledby="engine-tab">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Engine Size, Horsepower, and Drivetrain are optional fields.
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.fuel_type.label(class="form-label") }}
                                    {{ form.fuel_type(class="form-select", id="modal-fuel-type") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.transmission.label(class="form-label") }}
                                    {{ form.transmission(class="form-select", id="modal-transmission") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.engine_size.label(class="form-label") }}
                                    {{ form.engine_size(class="form-control", id="modal-engine-size") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.horsepower.label(class="form-label") }}
                                    {{ form.horsepower(class="form-control", id="modal-horsepower") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.drivetrain.label(class="form-label") }}
                                    {{ form.drivetrain(class="form-select", id="modal-drivetrain") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.fuel_economy.label(class="form-label") }}
                                {{ form.fuel_economy(class="form-control", id="modal-fuel-economy") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- Ownership & History Tab -->
                        <div class="tab-pane fade" id="ownership" role="tabpanel" aria-labelledby="ownership-tab">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.number_of_owners.label(class="form-label") }}
                                    {{ form.number_of_owners(class="form-control", id="modal-number-of-owners") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.odometer_reading.label(class="form-label") }}
                                    {{ form.odometer_reading(class="form-control", id="modal-odometer-reading") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.previous_owner_name.label(class="form-label") }}
                                    {{ form.previous_owner_name(class="form-control", id="modal-previous-owner-name") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.previous_owner_phone.label(class="form-label") }}
                                    {{ form.previous_owner_phone(class="form-control", id="modal-previous-owner-phone") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.previous_owner_email.label(class="form-label") }}
                                    {{ form.previous_owner_email(class="form-control", id="modal-previous-owner-email") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.accident_history.label(class="form-label") }}
                                {{ form.accident_history(class="form-control", rows="3", id="modal-accident-history") }}
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.service_records.label(class="form-label") }}
                                {{ form.service_records(class="form-control", rows="3", id="modal-service-records") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- Insurance & Documentation Tab -->
                        <div class="tab-pane fade" id="insurance" role="tabpanel" aria-labelledby="insurance-tab">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.insurance_company.label(class="form-label") }}
                                    {{ form.insurance_company(class="form-control", id="modal-insurance-company") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.insurance_policy_number.label(class="form-label") }}
                                    {{ form.insurance_policy_number(class="form-control", id="modal-insurance-policy-number") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.insurance_expiry.label(class="form-label") }}
                                    {{ form.insurance_expiry(class="form-control", id="modal-insurance-expiry") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.registration_number.label(class="form-label") }}
                                    {{ form.registration_number(class="form-control", id="modal-registration-number") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.vin_number.label(class="form-label") }}
                                    {{ form.vin_number(class="form-control", id="modal-vin-number") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Features & Condition Tab (Optional) -->
                        <div class="tab-pane fade" id="features" role="tabpanel" aria-labelledby="features-tab">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>All fields in this section are optional. You can skip them if not needed.
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.exterior_color.label(class="form-label") }}
                                    {{ form.exterior_color(class="form-control", id="modal-exterior-color") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.interior_color.label(class="form-label") }}
                                    {{ form.interior_color(class="form-control", id="modal-interior-color") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.condition_rating.label(class="form-label") }}
                                    {{ form.condition_rating(class="form-select", id="modal-condition-rating") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.features.label(class="form-label") }}
                                {{ form.features(class="form-control", rows="3", id="modal-features") }}
                                <div class="invalid-feedback"></div>
                                <div class="form-text">Optional: List vehicle features separated by commas (e.g., Sunroof, Leather Seats, Navigation System)</div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.warranty_info.label(class="form-label") }}
                                {{ form.warranty_info(class="form-control", rows="2", id="modal-warranty-info") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- Contact & Images Tab -->
                        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.contact_name.label(class="form-label") }}
                                    {{ form.contact_name(class="form-control", id="modal-contact-name") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.contact_phone.label(class="form-label") }}
                                    {{ form.contact_phone(class="form-control", id="modal-contact-phone") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label fw-bold fs-5 text-primary"><i class="fas fa-images me-2"></i>Vehicle Images</label>
                                <p class="text-muted mb-3">Upload up to 6 high-quality images to showcase your vehicle. Click on any slot below to select an image file.</p>
                                
                                <!-- 6 Image Upload Slots -->
                                <div class="row g-4">
                                    <div class="col-md-4" id="image-slot-1">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload(1)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';"
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <div class="upload-icon mb-3">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                                </div>
                                                <h6 class="text-dark mb-2 fw-bold">Image 1</h6>
                                                <p class="text-muted mb-0 small">Click to upload</p>
                                                <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                                            </div>
                                            <input type="file" id="image-input-1" accept="image/*" style="display: none;" onchange="handleImageUpload(1, this)">
                                            <img id="image-preview-1" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-2">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload(2)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';"
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <div class="upload-icon mb-3">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                                </div>
                                                <h6 class="text-dark mb-2 fw-bold">Image 2</h6>
                                                <p class="text-muted mb-0 small">Click to upload</p>
                                                <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                                            </div>
                                            <input type="file" id="image-input-2" accept="image/*" style="display: none;" onchange="handleImageUpload(2, this)">
                                            <img id="image-preview-2" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-3">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload(3)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';"
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <div class="upload-icon mb-3">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                                </div>
                                                <h6 class="text-dark mb-2 fw-bold">Image 3</h6>
                                                <p class="text-muted mb-0 small">Click to upload</p>
                                                <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                                            </div>
                                            <input type="file" id="image-input-3" accept="image/*" style="display: none;" onchange="handleImageUpload(3, this)">
                                            <img id="image-preview-3" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-4">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload(4)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';"
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <div class="upload-icon mb-3">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                                </div>
                                                <h6 class="text-dark mb-2 fw-bold">Image 4</h6>
                                                <p class="text-muted mb-0 small">Click to upload</p>
                                                <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                                            </div>
                                            <input type="file" id="image-input-4" accept="image/*" style="display: none;" onchange="handleImageUpload(4, this)">
                                            <img id="image-preview-4" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-5">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload(5)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';"
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <div class="upload-icon mb-3">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                                </div>
                                                <h6 class="text-dark mb-2 fw-bold">Image 5</h6>
                                                <p class="text-muted mb-0 small">Click to upload</p>
                                                <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                                            </div>
                                            <input type="file" id="image-input-5" accept="image/*" style="display: none;" onchange="handleImageUpload(5, this)">
                                            <img id="image-preview-5" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-6">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative" 
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important; 
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);" 
                                             onclick="triggerImageUpload(6)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';"
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100">
                                                <div class="upload-icon mb-3">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                                </div>
                                                <h6 class="text-dark mb-2 fw-bold">Image 6</h6>
                                                <p class="text-muted mb-0 small">Click to upload</p>
                                                <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                                            </div>
                                            <input type="file" id="image-input-6" accept="image/*" style="display: none;" onchange="handleImageUpload(6, this)">
                                            <img id="image-preview-6" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden input for form submission -->
                                {{ form.images(style="display: none;", id="modal-images", multiple=True) }}
                            </div>
                            
                            <div id="current-images" style="display: none;">
                                <h6 class="text-muted mb-2">Current Images</h6>
                                <div id="current-images-container" class="row g-2 mb-3"></div>
                                <div class="form-text text-info">
                                    <i class="fas fa-info-circle me-1"></i>You can add new images while keeping existing ones. Maximum 6 images total.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="fas fa-save me-1"></i>Add Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
let currentVehicleId = null;
let isEditMode = false;

function openAddModal() {
    currentVehicleId = null;
    isEditMode = false;
    document.getElementById('vehicleModalTitle').textContent = 'Add New Vehicle';
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save me-1"></i>Add Vehicle';
    document.getElementById('status-field').style.display = 'none';
    document.getElementById('current-images').style.display = 'none';
    document.getElementById('vehicleForm').reset();
    clearFormErrors();
    clearImagePreviews();
}

function clearImagePreviews() {
    clearAllImageSlots();
}

// Clear previews when modal is closed
document.getElementById('vehicleModal').addEventListener('hidden.bs.modal', function() {
    clearImagePreviews();
});

function openEditModal(vehicleId) {
    currentVehicleId = vehicleId;
    isEditMode = true;
    document.getElementById('vehicleModalTitle').textContent = 'Edit Vehicle';
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save me-1"></i>Update Vehicle';
    document.getElementById('status-field').style.display = 'block';
    
    // Fetch vehicle data
    showLoading();
    fetch(`/admin/get_vehicle/${vehicleId}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                populateForm(data.vehicle);
                const modal = new bootstrap.Modal(document.getElementById('vehicleModal'));
                modal.show();
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Error loading vehicle data', 'danger');
        });
}

function populateForm(vehicle) {
    // Basic Information
    document.getElementById('modal-title').value = vehicle.title;
    document.getElementById('modal-category').value = vehicle.category;
    document.getElementById('modal-make').value = vehicle.make;
    document.getElementById('modal-model').value = vehicle.model;
    document.getElementById('modal-year').value = vehicle.year;
    document.getElementById('modal-price').value = vehicle.price;
    document.getElementById('modal-mileage').value = vehicle.mileage;
    document.getElementById('modal-description').value = vehicle.description || '';
    document.getElementById('modal-status').value = vehicle.status;
    
    // Engine & Performance
    document.getElementById('modal-fuel-type').value = vehicle.fuel_type || '';
    document.getElementById('modal-transmission').value = vehicle.transmission || '';
    document.getElementById('modal-engine-size').value = vehicle.engine_size || '';
    document.getElementById('modal-horsepower').value = vehicle.horsepower || '';
    document.getElementById('modal-fuel-economy').value = vehicle.fuel_economy || '';
    document.getElementById('modal-drivetrain').value = vehicle.drivetrain || '';
    
    // Ownership & History
    document.getElementById('modal-number-of-owners').value = vehicle.number_of_owners || '';
    document.getElementById('modal-previous-owner-name').value = vehicle.previous_owner_name || '';
    document.getElementById('modal-previous-owner-phone').value = vehicle.previous_owner_phone || '';
    document.getElementById('modal-previous-owner-email').value = vehicle.previous_owner_email || '';
    document.getElementById('modal-odometer-reading').value = vehicle.odometer_reading || '';
    document.getElementById('modal-accident-history').value = vehicle.accident_history || '';
    document.getElementById('modal-service-records').value = vehicle.service_records || '';
    
    // Insurance & Documentation
    document.getElementById('modal-insurance-company').value = vehicle.insurance_company || '';
    document.getElementById('modal-insurance-policy-number').value = vehicle.insurance_policy_number || '';
    document.getElementById('modal-insurance-expiry').value = vehicle.insurance_expiry || '';
    document.getElementById('modal-registration-number').value = vehicle.registration_number || '';
    document.getElementById('modal-vin-number').value = vehicle.vin_number || '';
    
    // Features & Condition
    document.getElementById('modal-exterior-color').value = vehicle.exterior_color || '';
    document.getElementById('modal-interior-color').value = vehicle.interior_color || '';
    document.getElementById('modal-features').value = vehicle.features || '';
    document.getElementById('modal-condition-rating').value = vehicle.condition_rating || '';
    document.getElementById('modal-warranty-info').value = vehicle.warranty_info || '';
    
    // Contact Information
    document.getElementById('modal-contact-name').value = vehicle.contact_name;
    document.getElementById('modal-contact-phone').value = vehicle.contact_phone;
    
    // Load existing images into slots
    if (vehicle.images && vehicle.images.length > 0) {
        vehicle.images.forEach((imageName, index) => {
            if (index < 6) { // Only load up to 6 images
                const slotNumber = index + 1;
                const slot = document.getElementById(`image-slot-${slotNumber}`);
                const preview = document.getElementById(`image-preview-${slotNumber}`);
                const slotContent = slot.querySelector('.slot-content');
                
                // Display existing image
                preview.src = `/static/uploads/${imageName}`;
                preview.style.display = 'block';
                slotContent.style.display = 'none';
                
                // Add remove button for existing images
                if (!slot.querySelector('.remove-image-btn')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-danger position-absolute remove-image-btn';
                    removeBtn.style.cssText = 'top: 10px; right: 10px; padding: 5px 8px; z-index: 10;';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = function() { removeImage(slotNumber); };
                    slot.style.position = 'relative';
                    slot.appendChild(removeBtn);
                }
                
                // Update slot styling
                const uploadSlot = slot.querySelector('.image-upload-slot');
                if (uploadSlot) {
                    uploadSlot.style.border = '2px solid #28a745';
                    uploadSlot.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                }
            }
        });
    }
    
    clearFormErrors();
}

// Professional 6-slot image upload system
let uploadedImages = [];

function triggerImageUpload(slotNumber) {
    document.getElementById(`image-input-${slotNumber}`).click();
}

function handleImageUpload(slotNumber, input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showToast('Please select a valid image file.', 'error');
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Image size should be less than 5MB.', 'error');
        return;
    }
    
    const slot = document.getElementById(`image-slot-${slotNumber}`);
    const preview = document.getElementById(`image-preview-${slotNumber}`);
    const slotContent = slot.querySelector('.slot-content');
    
    // Read and display the image
    const reader = new FileReader();
    reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        slotContent.style.display = 'none';
        
        // Add remove button
        if (!slot.querySelector('.remove-image-btn')) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger position-absolute remove-image-btn';
            removeBtn.style.cssText = 'top: 10px; right: 10px; padding: 5px 8px; z-index: 10;';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() { removeImage(slotNumber); };
            slot.style.position = 'relative';
            slot.appendChild(removeBtn);
        }
        
        // Update the uploaded images array
        uploadedImages[slotNumber - 1] = file;
        updateFormFileInput();
        
        // Update slot styling
        const uploadSlot = slot.querySelector('.image-upload-slot');
        if (uploadSlot) {
            uploadSlot.style.border = '2px solid #28a745';
            uploadSlot.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        }
    };
    reader.readAsDataURL(file);
}

function removeImage(slotNumber) {
    const slot = document.getElementById(`image-slot-${slotNumber}`);
    const preview = document.getElementById(`image-preview-${slotNumber}`);
    const slotContent = slot.querySelector('.slot-content');
    const removeBtn = slot.querySelector('.remove-image-btn');
    const input = document.getElementById(`image-input-${slotNumber}`);
    
    // Reset the slot
    preview.style.display = 'none';
    preview.src = '';
    slotContent.style.display = 'block';
    input.value = '';
    
    // Remove the remove button
    if (removeBtn) removeBtn.remove();
    
    // Reset slot styling
    const uploadSlot = slot.querySelector('.image-upload-slot');
    if (uploadSlot) {
        uploadSlot.style.border = '2px dashed #007bff';
        uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    }
    
    // Update uploaded images array
    uploadedImages[slotNumber - 1] = null;
    updateFormFileInput();
}

function updateFormFileInput() {
    const formInput = document.getElementById('modal-images');
    const dataTransfer = new DataTransfer();
    
    // Add all uploaded files to the form input
    uploadedImages.forEach(file => {
        if (file) {
            dataTransfer.items.add(file);
        }
    });
    
    formInput.files = dataTransfer.files;
}

function clearAllImageSlots() {
    for (let i = 1; i <= 6; i++) {
        try {
            const slot = document.getElementById(`image-slot-${i}`);
            const preview = document.getElementById(`image-preview-${i}`);
            const slotContent = slot?.querySelector('.slot-content');
            const removeBtn = slot?.querySelector('.remove-image-btn');
            const input = document.getElementById(`image-input-${i}`);
            const uploadSlot = slot?.querySelector('.image-upload-slot');
            
            if (preview) {
                preview.style.display = 'none';
                preview.src = '';
            }
            if (slotContent) slotContent.style.display = 'block';
            if (input) input.value = '';
            if (removeBtn) removeBtn.remove();
            if (uploadSlot) {
                uploadSlot.style.border = '2px dashed #007bff';
                uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            }
        } catch (error) {
            console.warn(`Error clearing image slot ${i}:`, error);
        }
    }
    uploadedImages = [];
}

function clearFormErrors() {
    const formErrors = document.getElementById('form-errors');
    if (formErrors) formErrors.style.display = 'none';
    document.querySelectorAll('.is-invalid').forEach(el => {
        if (el) el.classList.remove('is-invalid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        if (el) el.textContent = '';
    });
}

function showFormErrors(errors) {
    clearFormErrors();
    
    let errorMessages = [];
    for (const [field, message] of Object.entries(errors)) {
        const input = document.getElementById(`modal-${field.replace('_', '-')}`);
        if (input) {
            input.classList.add('is-invalid');
            const feedback = input.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = message;
        }
        errorMessages.push(`${field}: ${message}`);
    }
    
    if (errorMessages.length > 0) {
        const errorDiv = document.getElementById('form-errors');
        if (errorDiv) {
            errorDiv.innerHTML = errorMessages.join('<br>');
            errorDiv.style.display = 'block';
        }
    }
}

function toggleStatus(vehicleId) {
    if (!confirm('Are you sure you want to change the vehicle status?')) return;
    
    showLoading();
    fetch(`/admin/toggle_status/${vehicleId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            updateVehicleStatus(vehicleId, data.new_status);
            showToast(data.message, 'success');
            updateStatistics();
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error updating vehicle status', 'danger');
    });
}

function deleteVehicle(vehicleId) {
    if (!confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) return;
    
    showLoading();
    fetch(`/admin/delete_vehicle/${vehicleId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            removeVehicleRow(vehicleId);
            showToast(data.message, 'success');
            updateStatistics();
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error deleting vehicle', 'danger');
    });
}

function updateVehicleStatus(vehicleId, newStatus) {
    const row = document.getElementById(`vehicle-${vehicleId}`);
    const badge = row.querySelector('.status-badge');
    badge.className = `badge ${newStatus === 'available' ? 'bg-success' : 'bg-danger'} status-badge`;
    badge.textContent = newStatus === 'available' ? 'Available' : 'Sold';
}

function removeVehicleRow(vehicleId) {
    const row = document.getElementById(`vehicle-${vehicleId}`);
    row.remove();
    
    // Check if table is empty
    const tbody = document.getElementById('vehicles-tbody');
    if (tbody.children.length === 0) {
        showEmptyState();
    }
}

function showEmptyState() {
    document.getElementById('vehicles-container').innerHTML = `
        <div class="text-center py-4" id="empty-state">
            <i class="fas fa-car fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No vehicles listed yet</h4>
            <p class="text-muted">Start by adding your first vehicle to the inventory.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                <i class="fas fa-plus me-1"></i>Add First Vehicle
            </button>
        </div>
    `;
}

function updateStatistics() {
    const rows = document.querySelectorAll('#vehicles-tbody tr');
    const total = rows.length;
    let available = 0;
    let sold = 0;
    
    rows.forEach(row => {
        const badge = row.querySelector('.status-badge');
        if (badge.textContent === 'Available') available++;
        else sold++;
    });
    
    document.getElementById('total-count').textContent = total;
    document.getElementById('available-count').textContent = available;
    document.getElementById('sold-count').textContent = sold;
}

function showLoading() {
    document.getElementById('loading-overlay').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Form submission handler
document.getElementById('vehicleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('Form submission started');
    
    // Basic validation
    const title = document.getElementById('modal-title').value.trim();
    const make = document.getElementById('modal-make').value.trim();
    const model = document.getElementById('modal-model').value.trim();
    const year = document.getElementById('modal-year').value;
    const price = document.getElementById('modal-price').value;
    const contactName = document.getElementById('modal-contact-name').value.trim();
    const contactPhone = document.getElementById('modal-contact-phone').value.trim();
    
    if (!title || !make || !model || !year || !price || !contactName || !contactPhone) {
        showToast('Please fill in all required fields', 'danger');
        return;
    }
    
    const formData = new FormData(this);
    const url = isEditMode ? `/admin/edit_vehicle/${currentVehicleId}` : '/admin/add_vehicle';
    
    console.log('Submitting to:', url);
    console.log('Is edit mode:', isEditMode);
    
    showLoading();
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        hideLoading();
        if (data.success) {
            showToast(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('vehicleModal'));
            modal.hide();
            
            // Reload page to refresh data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            if (data.errors) {
                console.log('Form validation errors:', data.errors);
                showFormErrors(data.errors);
            } else {
                showToast(data.message, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Form submission error:', error);
        hideLoading();
        showToast('Error submitting form: ' + error.message, 'danger');
    });
});

// Reset form when modal is hidden
document.getElementById('vehicleModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('vehicleForm').reset();
    clearFormErrors();
});
</script>
{% endblock %}
