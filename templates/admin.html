{% extends "base.html" %}

{% block title %}Admin Dashboard - AutoMarket{% endblock %}

{% block content %}
<style>
/* Enhanced form styling for better text visibility */
.modal-content .form-control,
.modal-content .form-select {
    color: #212529 !important;
    font-weight: 500 !important;
    border: 2px solid #dee2e6 !important;
    background-color: white !important;
}

.modal-content .form-control:focus,
.modal-content .form-select:focus {
    color: #212529 !important;
    background-color: white !important;
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.modal-content .form-control::placeholder {
    color: #6c757d !important;
    opacity: 0.8 !important;
    font-weight: 400 !important;
}

.modal-content .form-select option {
    color: #212529 !important;
    background-color: white !important;
    font-weight: 500;
}

/* Ensure dropdown options are visible */
.modal-content select option {
    color: #212529 !important;
    background-color: white !important;
    font-weight: 500;
}

.modal-content .form-control,
.modal-content .form-select,
.modal-content input,
.modal-content textarea,
.modal-content select {
    color: #212529 !important;
    background-color: white !important;
}
</style>
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cog me-2 text-primary"></i>Admin Dashboard</h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                    <i class="fas fa-plus me-1"></i>Add New Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Vehicles</h5>
                    <h2 class="text-primary" id="total-count">{{ vehicles|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Available</h5>
                    <h2 class="text-success" id="available-count">{{ vehicles|selectattr("status", "equalto", "available")|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Sold</h5>
                    <h2 class="text-danger" id="sold-count">{{ vehicles|selectattr("status", "equalto", "sold")|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Categories</h5>
                    <h2 class="text-info">3</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicles Management Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-car me-2"></i>Vehicle Management</h5>
        </div>
        <div class="card-body">
            <div id="vehicles-container">
                {% if vehicles %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="vehicles-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Vehicle</th>
                                    <th>Category</th>
                                    <th>Year</th>
                                    <th>Price</th>
                                    <th>Mileage</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicles-tbody">
                                {% for vehicle in vehicles %}
                                    <tr id="vehicle-{{ vehicle.id }}">
                                        <td>
                                            {% if vehicle.images_list and vehicle.images_list|length > 0 and vehicle.images_list[0] and vehicle.images_list[0] != '' %}
                                                <div class="position-relative">
                                                    <img src="{{ url_for('static', filename='uploads/' + vehicle.images_list[0]) }}"
                                                         class="img-thumbnail" style="width: 60px; height: 45px; object-fit: cover; border-radius: 6px;"
                                                         alt="{{ vehicle.title }}"
                                                         onerror="console.log('Image failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                    <div class="bg-light border d-none align-items-center justify-content-center"
                                                         style="width: 60px; height: 45px; border-radius: 6px;">
                                                        <i class="fas fa-car text-muted"></i>
                                                    </div>
                                                    {% if vehicle.images_list|length > 1 %}
                                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary" style="font-size: 10px;">
                                                            {{ vehicle.images_list|length }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <div class="bg-light border d-flex align-items-center justify-content-center"
                                                     style="width: 60px; height: 45px; border-radius: 6px;">
                                                    <i class="fas fa-car text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ vehicle.title }}</strong><br>
                                            <small class="text-muted">{{ vehicle.make }} {{ vehicle.model }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ vehicle.category }}</span>
                                        </td>
                                        <td>{{ vehicle.year }}</td>
                                        <td class="text-success">
                                            <strong>${{ "{:,.0f}".format(vehicle.price) }}</strong>
                                        </td>
                                        <td>{{ "{:,}".format(vehicle.mileage) }} mi</td>
                                        <td>
                                            {% if vehicle.status == 'available' %}
                                                <span class="badge bg-success status-badge">Available</span>
                                            {% else %}
                                                <span class="badge bg-danger status-badge">Sold</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ url_for('vehicle_detail', vehicle_id=vehicle.id) }}"
                                                   class="btn btn-outline-info" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-warning" title="Edit"
                                                        onclick="openEditModal('{{ vehicle.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" title="Toggle Status"
                                                        onclick="toggleStatus('{{ vehicle.id }}')">
                                                    <i class="fas fa-exchange-alt"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" title="Delete"
                                                        onclick="deleteVehicle('{{ vehicle.id }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4" id="empty-state">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No vehicles listed yet</h4>
                        <p class="text-muted">Start by adding your first vehicle to the inventory.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                            <i class="fas fa-plus me-1"></i>Add First Vehicle
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center" id="vehicleModalTitle">
                    <i class="fas fa-car me-2"></i>Add New Vehicle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="vehicleForm" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div id="form-errors" class="alert alert-danger" style="display: none;"></div>

                    <!-- Wizard Progress Indicator -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center position-relative">
                            <!-- Progress Line -->
                            <div class="position-absolute w-100" style="top: 20px; height: 2px; background-color: #e9ecef; z-index: 0;"></div>
                            <div class="position-absolute" id="progress-line" style="top: 20px; height: 2px; background-color: #007bff; z-index: 1; width: 0%; transition: width 0.3s ease;"></div>

                            <!-- Step 1: Basic Info -->
                            <div class="text-center position-relative" style="z-index: 2;">
                                <div class="step-indicator bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,123,255,0.3);">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="mt-2 small fw-bold text-primary">Step 1</div>
                                <div class="small text-muted">Basic Info</div>
                            </div>

                            <!-- Step 2: Engine -->
                            <div class="text-center position-relative" style="z-index: 2;">
                                <div class="step-indicator bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 3px solid white;">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <div class="mt-2 small text-muted">Step 2</div>
                                <div class="small text-muted">Engine</div>
                            </div>

                            <!-- Step 3: History -->
                            <div class="text-center position-relative" style="z-index: 2;">
                                <div class="step-indicator bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 3px solid white;">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="mt-2 small text-muted">Step 3</div>
                                <div class="small text-muted">History</div>
                            </div>

                            <!-- Step 4: Insurance -->
                            <div class="text-center position-relative" style="z-index: 2;">
                                <div class="step-indicator bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 3px solid white;">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="mt-2 small text-muted">Step 4</div>
                                <div class="small text-muted">Insurance</div>
                            </div>

                            <!-- Step 5: Features -->
                            <div class="text-center position-relative" style="z-index: 2;">
                                <div class="step-indicator bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 3px solid white;">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="mt-2 small text-muted">Step 5</div>
                                <div class="small text-muted">Features</div>
                            </div>

                            <!-- Step 6: Images & Save -->
                            <div class="text-center position-relative" style="z-index: 2;">
                                <div class="step-indicator bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; border: 3px solid white;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="mt-2 small text-muted">Step 6</div>
                                <div class="small text-muted">Finish</div>
                            </div>
                        </div>
                        <hr class="my-4">
                    </div>

                    <!-- Hidden Tab Navigation (wizard-style) -->
                    <ul class="nav nav-tabs d-none" id="vehicleTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab"></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="engine-tab" data-bs-toggle="tab" data-bs-target="#engine" type="button" role="tab"></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ownership-tab" data-bs-toggle="tab" data-bs-target="#ownership" type="button" role="tab"></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="insurance-tab" data-bs-toggle="tab" data-bs-target="#insurance" type="button" role="tab"></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab"></button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab"></button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="vehicleTabContent">
                        <!-- Basic Information Tab -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                            <div class="card border-0 rounded-3 p-4 mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%); border: 1px solid #dee2e6 !important;">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Essential Vehicle Information</h6>
                                <p class="text-dark mb-3">Please provide the basic details about the vehicle. All fields marked with <span class="text-danger">*</span> are required.</p>

                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold text-dark">{{ form.title.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.title(class="form-control form-control-lg shadow-sm", id="modal-title", placeholder="e.g., 2020 Honda Civic LX - Excellent Condition", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                        <div class="form-text text-dark">Create an attractive title that highlights key features</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-dark">{{ form.category.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.category(class="form-select form-select-lg shadow-sm", id="modal-category", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-dark">{{ form.make.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.make(class="form-control shadow-sm", id="modal-make", placeholder="e.g., Honda, Toyota, Ford", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-dark">{{ form.model.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.model(class="form-control shadow-sm", id="modal-model", placeholder="e.g., Civic, Camry, F-150", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold text-dark">{{ form.year.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.year(class="form-control shadow-sm", id="modal-year", placeholder="e.g., 2020", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-dark">{{ form.price.label.text }} <span class="text-danger">*</span></label>
                                        <div class="input-group input-group-lg shadow-sm">
                                            <span class="input-group-text bg-success text-white"><i class="fas fa-dollar-sign"></i></span>
                                            {{ form.price(class="form-control", id="modal-price", placeholder="e.g., 25000", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        </div>
                                        <div class="invalid-feedback"></div>
                                        <div class="form-text text-dark">Enter the asking price in USD</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-dark">{{ form.mileage.label.text }} <span class="text-danger">*</span></label>
                                        <div class="input-group input-group-lg shadow-sm">
                                            {{ form.mileage(class="form-control", id="modal-mileage", placeholder="e.g., 45000", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                            <span class="input-group-text bg-info text-white"><i class="fas fa-road"></i> miles</span>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                        <div class="form-text text-dark">Current odometer reading</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark">{{ form.description.label.text }}</label>
                                    {{ form.description(class="form-control shadow-sm", rows="4", id="modal-description", placeholder="Describe the vehicle's condition, features, and any special details. Be detailed and honest to attract genuine buyers.", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text text-dark">A good description increases buyer interest</div>
                                </div>
                            </div>

                            <!-- Hidden status field with default value -->
                            {{ form.status(id="modal-status", value="available", style="display: none;") }}
                        </div>

                        <!-- Engine & Performance Tab -->
                        <div class="tab-pane fade" id="engine" role="tabpanel" aria-labelledby="engine-tab">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Engine Size, Horsepower, and Drivetrain are optional fields.
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.fuel_type.label(class="form-label") }}
                                    {{ form.fuel_type(class="form-select", id="modal-fuel-type") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.transmission.label(class="form-label") }}
                                    {{ form.transmission(class="form-select", id="modal-transmission") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.engine_size.label(class="form-label") }}
                                    {{ form.engine_size(class="form-control", id="modal-engine-size") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.horsepower.label(class="form-label") }}
                                    {{ form.horsepower(class="form-control", id="modal-horsepower") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.drivetrain.label(class="form-label") }}
                                    {{ form.drivetrain(class="form-select", id="modal-drivetrain") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.fuel_economy.label(class="form-label") }}
                                {{ form.fuel_economy(class="form-control", id="modal-fuel-economy") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Ownership & History Tab -->
                        <div class="tab-pane fade" id="ownership" role="tabpanel" aria-labelledby="ownership-tab">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.number_of_owners.label(class="form-label") }}
                                    {{ form.number_of_owners(class="form-control", id="modal-number-of-owners") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.odometer_reading.label(class="form-label") }}
                                    {{ form.odometer_reading(class="form-control", id="modal-odometer-reading") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.previous_owner_name.label(class="form-label") }}
                                    {{ form.previous_owner_name(class="form-control", id="modal-previous-owner-name") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.previous_owner_phone.label(class="form-label") }}
                                    {{ form.previous_owner_phone(class="form-control", id="modal-previous-owner-phone") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.previous_owner_email.label(class="form-label") }}
                                    {{ form.previous_owner_email(class="form-control", id="modal-previous-owner-email") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.accident_history.label(class="form-label") }}
                                {{ form.accident_history(class="form-control", rows="3", id="modal-accident-history") }}
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="mb-3">
                                {{ form.service_records.label(class="form-label") }}
                                {{ form.service_records(class="form-control", rows="3", id="modal-service-records") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Insurance & Documentation Tab -->
                        <div class="tab-pane fade" id="insurance" role="tabpanel" aria-labelledby="insurance-tab">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.insurance_company.label(class="form-label") }}
                                    {{ form.insurance_company(class="form-control", id="modal-insurance-company") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.insurance_policy_number.label(class="form-label") }}
                                    {{ form.insurance_policy_number(class="form-control", id="modal-insurance-policy-number") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.insurance_expiry.label(class="form-label") }}
                                    {{ form.insurance_expiry(class="form-control", id="modal-insurance-expiry") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.registration_number.label(class="form-label") }}
                                    {{ form.registration_number(class="form-control", id="modal-registration-number") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.vin_number.label(class="form-label") }}
                                    {{ form.vin_number(class="form-control", id="modal-vin-number") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Features & Condition Tab (Optional) -->
                        <div class="tab-pane fade" id="features" role="tabpanel" aria-labelledby="features-tab">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>All fields in this section are optional. You can skip them if not needed.
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.exterior_color.label(class="form-label") }}
                                    {{ form.exterior_color(class="form-control", id="modal-exterior-color") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.interior_color.label(class="form-label") }}
                                    {{ form.interior_color(class="form-control", id="modal-interior-color") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    {{ form.condition_rating.label(class="form-label") }}
                                    {{ form.condition_rating(class="form-select", id="modal-condition-rating") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.features.label(class="form-label") }}
                                {{ form.features(class="form-control", rows="3", id="modal-features") }}
                                <div class="invalid-feedback"></div>
                                <div class="form-text">Optional: List vehicle features separated by commas (e.g., Sunroof, Leather Seats, Navigation System)</div>
                            </div>

                            <div class="mb-3">
                                {{ form.warranty_info.label(class="form-label") }}
                                {{ form.warranty_info(class="form-control", rows="2", id="modal-warranty-info") }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Contact & Images Tab -->
                        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                            <div class="card border-0 rounded-3 p-4 mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%); border: 1px solid #dee2e6 !important;">
                                <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>Contact Information</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-dark">{{ form.contact_name.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.contact_name(class="form-control shadow-sm", id="modal-contact-name", placeholder="Your full name", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-dark">{{ form.contact_phone.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.contact_phone(class="form-control shadow-sm", id="modal-contact-phone", placeholder="(555) 123-4567", style="border: 2px solid #dee2e6; background-color: white; color: #212529; font-weight: 500;") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-0 rounded-3 p-4" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 1px solid #dee2e6 !important;">
                                <label class="form-label fw-bold fs-5 text-warning"><i class="fas fa-images me-2"></i>Vehicle Images</label>
                                <p class="text-dark mb-3">Upload up to 6 high-quality images to showcase your vehicle. Click on any slot below to select an image file.</p>

                                <!-- 6 Image Upload Slots -->
                                <div class="row g-4">
                                    <div class="col-md-4" id="image-slot-1">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative"
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important;
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);"
                                             onclick="triggerImageUpload(1)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100"></div>
                                            <input type="file" id="image-input-1" accept="image/*" style="display: none;" onchange="handleImageUpload(1, this)">
                                            <img id="image-preview-1" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-2">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative"
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important;
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);"
                                             onclick="triggerImageUpload(2)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100"></div>
                                            <input type="file" id="image-input-2" accept="image/*" style="display: none;" onchange="handleImageUpload(2, this)">
                                            <img id="image-preview-2" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-3">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative"
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important;
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);"
                                             onclick="triggerImageUpload(3)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100"></div>
                                            <input type="file" id="image-input-3" accept="image/*" style="display: none;" onchange="handleImageUpload(3, this)">
                                            <img id="image-preview-3" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-4">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative"
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important;
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);"
                                             onclick="triggerImageUpload(4)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100"></div>
                                            <input type="file" id="image-input-4" accept="image/*" style="display: none;" onchange="handleImageUpload(4, this)">
                                            <img id="image-preview-4" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-5">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative"
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important;
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);"
                                             onclick="triggerImageUpload(5)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100"></div>
                                            <input type="file" id="image-input-5" accept="image/*" style="display: none;" onchange="handleImageUpload(5, this)">
                                            <img id="image-preview-5" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="image-slot-6">
                                        <div class="image-upload-slot border rounded-3 p-4 text-center position-relative"
                                             style="min-height: 200px; cursor: pointer; border: 2px dashed #007bff !important;
                                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                                    transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,123,255,0.1);"
                                             onclick="triggerImageUpload(6)"
                                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)';"
                                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,123,255,0.1)';">
                                            <div class="slot-content d-flex flex-column align-items-center justify-content-center h-100"></div>
                                            <input type="file" id="image-input-6" accept="image/*" style="display: none;" onchange="handleImageUpload(6, this)">
                                            <img id="image-preview-6" class="img-fluid rounded-3 w-100 h-100" style="display: none; object-fit: cover; position: absolute; top: 0; left: 0;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden input for form submission -->
                                {{ form.images(style="display: none;", id="modal-images", multiple=True) }}
                            </div>

                            <div id="current-images" style="display: none;">
                                <h6 class="text-muted mb-2">Current Images</h6>
                                <div id="current-images-container" class="row g-2 mb-3"></div>
                                <div class="form-text text-info">
                                    <i class="fas fa-info-circle me-1"></i>You can add new images while keeping existing ones. Maximum 6 images total.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" id="prev-tab-btn" style="display: none;">
                            <i class="fas fa-arrow-left me-1"></i>Previous Step
                        </button>
                    </div>

                    <div class="text-center">
                        <span class="badge bg-primary px-3 py-2" id="step-counter">Step 1 of 6</span>
                    </div>

                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="next-tab-btn">
                            Next Step <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submit-btn" style="display: none;">
                            <i class="fas fa-save me-1"></i>Save Vehicle
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
let currentVehicleId = null;
let isEditMode = false;
let currentTabIndex = 0; // Initialize currentTabIndex

function openAddModal() {
    currentVehicleId = null;
    isEditMode = false;
    document.getElementById('vehicleModalTitle').innerHTML = '<i class="fas fa-car me-2"></i>Add New Vehicle';
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-check me-1"></i>Save Vehicle';
    document.getElementById('status-field').style.display = 'none';
    document.getElementById('current-images').style.display = 'none';
    document.getElementById('vehicleForm').reset();
    clearFormErrors();
    clearImagePreviews();

    // Reset to first tab
    resetToFirstTab();
    updateProgressIndicator(0); // Explicitly set to 0 for new modal
    updateNavigationButtons();
}

function clearImagePreviews() {
    clearAllImageSlots();
}

// Clear previews when modal is closed
document.getElementById('vehicleModal').addEventListener('hidden.bs.modal', function() {
    clearImagePreviews();
});

function openEditModal(vehicleId) {
    currentVehicleId = vehicleId;
    isEditMode = true;
    document.getElementById('vehicleModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Vehicle';
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-check me-1"></i>Update Vehicle';
    document.getElementById('status-field').style.display = 'block';

    // Fetch vehicle data
    showLoading();
    fetch(`/admin/get_vehicle/${vehicleId}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                populateForm(data.vehicle);
                const modal = new bootstrap.Modal(document.getElementById('vehicleModal'));
                modal.show();
                // After populating and showing, update tab UI
                currentTabIndex = 0; // Ensure it's reset to the first tab for UI update
                updateProgressIndicator(currentTabIndex);
                updateNavigationButtons();
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Error loading vehicle data', 'danger');
        });
}

function populateForm(vehicle) {
    // Basic Information
    document.getElementById('modal-title').value = vehicle.title;
    document.getElementById('modal-category').value = vehicle.category;
    document.getElementById('modal-make').value = vehicle.make;
    document.getElementById('modal-model').value = vehicle.model;
    document.getElementById('modal-year').value = vehicle.year;
    document.getElementById('modal-price').value = vehicle.price;
    document.getElementById('modal-mileage').value = vehicle.mileage;
    document.getElementById('modal-description').value = vehicle.description || '';
    document.getElementById('modal-status').value = vehicle.status;

    // Engine & Performance
    document.getElementById('modal-fuel-type').value = vehicle.fuel_type || '';
    document.getElementById('modal-transmission').value = vehicle.transmission || '';
    document.getElementById('modal-engine-size').value = vehicle.engine_size || '';
    document.getElementById('modal-horsepower').value = vehicle.horsepower || '';
    document.getElementById('modal-fuel-economy').value = vehicle.fuel_economy || '';
    document.getElementById('modal-drivetrain').value = vehicle.drivetrain || '';

    // Ownership & History
    document.getElementById('modal-number-of-owners').value = vehicle.number_of_owners || '';
    document.getElementById('modal-previous-owner-name').value = vehicle.previous_owner_name || '';
    document.getElementById('modal-previous-owner-phone').value = vehicle.previous_owner_phone || '';
    document.getElementById('modal-previous-owner-email').value = vehicle.previous_owner_email || '';
    document.getElementById('modal-odometer-reading').value = vehicle.odometer_reading || '';
    document.getElementById('modal-accident-history').value = vehicle.accident_history || '';
    document.getElementById('modal-service-records').value = vehicle.service_records || '';

    // Insurance & Documentation
    document.getElementById('modal-insurance-company').value = vehicle.insurance_company || '';
    document.getElementById('modal-insurance-policy-number').value = vehicle.insurance_policy_number || '';
    document.getElementById('modal-insurance-expiry').value = vehicle.insurance_expiry || '';
    document.getElementById('modal-registration-number').value = vehicle.registration_number || '';
    document.getElementById('modal-vin-number').value = vehicle.vin_number || '';

    // Features & Condition
    document.getElementById('modal-exterior-color').value = vehicle.exterior_color || '';
    document.getElementById('modal-interior-color').value = vehicle.interior_color || '';
    document.getElementById('modal-features').value = vehicle.features || '';
    document.getElementById('modal-condition-rating').value = vehicle.condition_rating || '';
    document.getElementById('modal-warranty-info').value = vehicle.warranty_info || '';

    // Contact Information
    document.getElementById('modal-contact-name').value = vehicle.contact_name;
    document.getElementById('modal-contact-phone').value = vehicle.contact_phone;

    // Load existing images into slots
    if (vehicle.images && vehicle.images.length > 0) {
        vehicle.images.forEach((imageName, index) => {
            if (index < 6) { // Only load up to 6 images
                const slotNumber = index + 1;
                const slot = document.getElementById(`image-slot-${slotNumber}`);
                const preview = document.getElementById(`image-preview-${slotNumber}`);
                const slotContent = slot.querySelector('.slot-content');

                // Display existing image
                preview.src = `/static/uploads/${imageName}`;
                preview.style.display = 'block';
                slotContent.style.display = 'none';

                // Add remove button for existing images
                if (!slot.querySelector('.remove-image-btn')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-danger position-absolute remove-image-btn';
                    removeBtn.style.cssText = 'top: 10px; right: 10px; padding: 5px 8px; z-index: 10;';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = function() { removeImage(slotNumber); };
                    slot.style.position = 'relative';
                    slot.appendChild(removeBtn);
                }

                // Update slot styling
                const uploadSlot = slot.querySelector('.image-upload-slot');
                if (uploadSlot) {
                    uploadSlot.style.border = '2px solid #28a745';
                    uploadSlot.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                }
            }
        });
    }

    clearFormErrors();
}

// Professional 6-slot image upload system
let uploadedImages = [];

function triggerImageUpload(slotNumber) {
    document.getElementById(`image-input-${slotNumber}`).click();
}

function handleImageUpload(slotNumber, input) {
    const file = input.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
        showToast('Please select a valid image file.', 'error');
        return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Image size should be less than 5MB.', 'error');
        return;
    }

    const slot = document.getElementById(`image-slot-${slotNumber}`);
    const preview = document.getElementById(`image-preview-${slotNumber}`);
    const slotContent = slot.querySelector('.slot-content');

    // Read and display the image
    const reader = new FileReader();
    reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        slotContent.style.display = 'none';

        // Add remove button
        if (!slot.querySelector('.remove-image-btn')) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger position-absolute remove-image-btn';
            removeBtn.style.cssText = 'top: 10px; right: 10px; padding: 5px 8px; z-index: 10;';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() { removeImage(slotNumber); };
            slot.style.position = 'relative';
            slot.appendChild(removeBtn);
        }

        // Update the uploaded images array
        uploadedImages[slotNumber - 1] = file;
        updateFormFileInput();

        // Update slot styling
        const uploadSlot = slot.querySelector('.image-upload-slot');
        if (uploadSlot) {
            uploadSlot.style.border = '2px solid #28a745';
            uploadSlot.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
        }
    };
    reader.readAsDataURL(file);
}

function removeImage(slotNumber) {
    const slot = document.getElementById(`image-slot-${slotNumber}`);
    const preview = document.getElementById(`image-preview-${slotNumber}`);
    const slotContent = slot.querySelector('.slot-content');
    const removeBtn = slot.querySelector('.remove-image-btn');
    const input = document.getElementById(`image-input-${slotNumber}`);

    // Reset the slot
    preview.style.display = 'none';
    preview.src = '';
    slotContent.style.display = 'block';
    input.value = '';

    // Remove the remove button
    if (removeBtn) removeBtn.remove();

    // Reset slot styling
    const uploadSlot = slot.querySelector('.image-upload-slot');
    if (uploadSlot) {
        uploadSlot.style.border = '2px dashed #007bff';
        uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    }

    // Update uploaded images array
    uploadedImages[slotNumber - 1] = null;
    updateFormFileInput();
}

function updateFormFileInput() {
    const formInput = document.getElementById('modal-images');
    const dataTransfer = new DataTransfer();

    // Add all uploaded files to the form input
    uploadedImages.forEach(file => {
        if (file) {
            dataTransfer.items.add(file);
        }
    });

    formInput.files = dataTransfer.files;
}

function clearAllImageSlots() {
    for (let i = 1; i <= 6; i++) {
        try {
            const slot = document.getElementById(`image-slot-${i}`);
            const preview = document.getElementById(`image-preview-${i}`);
            const slotContent = slot?.querySelector('.slot-content');
            const removeBtn = slot?.querySelector('.remove-image-btn');
            const input = document.getElementById(`image-input-${i}`);
            const uploadSlot = slot?.querySelector('.image-upload-slot');

            if (preview) {
                preview.style.display = 'none';
                preview.src = '';
            }
            if (slotContent) slotContent.style.display = 'block';
            if (input) input.value = '';
            if (removeBtn) removeBtn.remove();
            if (uploadSlot) {
                uploadSlot.style.border = '2px dashed #007bff';
                uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            }
        } catch (error) {
            console.warn(`Error clearing image slot ${i}:`, error);
        }
    }
    uploadedImages = [];
}

// Fix for the null element error
function updateTabNavigation() {
    const tabButtons = ['basic-tab', 'engine-tab', 'ownership-tab', 'insurance-tab', 'features-tab', 'contact-tab'];

    tabButtons.forEach((tabId, index) => {
        const tabElement = document.getElementById(tabId);
        if (tabElement) {
            tabElement.addEventListener('click', function() {
                currentTabIndex = index;
                updateProgressIndicator(currentTabIndex);
                updateNavigationButtons();
            });
        } else {
            console.warn(`Tab element ${tabId} not found`);
        }
    });
}

// Fix any potential NodeList.map issues
function safeQuerySelectorAll(selector) {
    return Array.from(document.querySelectorAll(selector));
}

function clearFormErrors() {
    const formErrors = document.getElementById('form-errors');
    if (formErrors) formErrors.style.display = 'none';

    Array.from(document.querySelectorAll('.is-invalid')).forEach(el => {
        if (el) el.classList.remove('is-invalid');
    });

    Array.from(document.querySelectorAll('.invalid-feedback')).forEach(el => {
        if (el) el.textContent = '';
    });
}

function showFormErrors(errors) {
    clearFormErrors();

    let errorMessages = [];
    let missingFields = [];

    for (const [field, messages] of Object.entries(errors)) {
        const input = document.getElementById(`modal-${field.replace('_', '-')}`);
        if (input) {
            input.classList.add('is-invalid');
            const feedback = input.parentNode.querySelector('.invalid-feedback');
            if (feedback && Array.isArray(messages)) {
                feedback.textContent = messages[0];
            }
        }

        // Collect field names for user-friendly message
        const fieldNames = {
            'title': 'Vehicle Title',
            'make': 'Make',
            'model': 'Model',
            'year': 'Year',
            'price': 'Price',
            'mileage': 'Mileage',
            'contact_name': 'Contact Name',
            'contact_phone': 'Contact Phone'
        };

        if (fieldNames[field]) {
            missingFields.push(fieldNames[field]);
        }
    }

    if (missingFields.length > 0) {
        const fieldsText = missingFields.join(', ');
        showToast(`Please fill in the following required fields: ${fieldsText}`, 'danger');

        const errorDiv = document.getElementById('form-errors');
        if (errorDiv) {
            errorDiv.innerHTML = `<strong>Missing required fields:</strong> ${fieldsText}`;
            errorDiv.style.display = 'block';
        }
    }
}

function toggleStatus(vehicleId) {
    if (!confirm('Are you sure you want to change the vehicle status?')) return;

    showLoading();
    fetch(`/admin/toggle_status/${vehicleId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            updateVehicleStatus(vehicleId, data.new_status);
            showToast(data.message, 'success');
            updateStatistics();
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error updating vehicle status', 'danger');
    });
}

function deleteVehicle(vehicleId) {
    if (!confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) return;

    showLoading();
    fetch(`/admin/delete_vehicle/${vehicleId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            removeVehicleRow(vehicleId);
            showToast(data.message, 'success');
            updateStatistics();
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error deleting vehicle', 'danger');
    });
}

function updateVehicleStatus(vehicleId, newStatus) {
    const row = document.getElementById(`vehicle-${vehicleId}`);
    const badge = row.querySelector('.status-badge');
    badge.className = `badge ${newStatus === 'available' ? 'bg-success' : 'bg-danger'} status-badge`;
    badge.textContent = newStatus === 'available' ? 'Available' : 'Sold';
}

function removeVehicleRow(vehicleId) {
    const row = document.getElementById(`vehicle-${vehicleId}`);
    row.remove();

    // Check if table is empty
    const tbody = document.getElementById('vehicles-tbody');
    if (tbody.children.length === 0) {
        showEmptyState();
    }
}

function showEmptyState() {
    document.getElementById('vehicles-container').innerHTML = `
        <div class="text-center py-4" id="empty-state">
            <i class="fas fa-car fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No vehicles listed yet</h4>
            <p class="text-muted">Start by adding your first vehicle to the inventory.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openAddModal()">
                <i class="fas fa-plus me-1"></i>Add First Vehicle
            </button>
        </div>
    `;
}

function updateStatistics() {
    const rows = Array.from(document.querySelectorAll('#vehicles-tbody tr'));
    const total = rows.length;
    let available = 0;
    let sold = 0;

    rows.forEach(row => {
        const badge = row.querySelector('.status-badge');
        if (badge && badge.textContent === 'Available') available++;
        else if (badge) sold++;
    });

    const totalCount = document.getElementById('total-count');
    const availableCount = document.getElementById('available-count');
    const soldCount = document.getElementById('sold-count');

    if (totalCount) totalCount.textContent = total;
    if (availableCount) availableCount.textContent = available;
    if (soldCount) soldCount.textContent = sold;
}

function showLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'block';
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Form submission handler
document.getElementById('vehicleForm').addEventListener('submit', function(e) {
    e.preventDefault();

    console.log('Form submission started - event triggered!');
    console.log('Form element:', this);
    console.log('Event:', e);

    // Simplified validation - let backend handle validation
    console.log('Skipping frontend validation, letting backend handle it');

    const formData = new FormData(this);
    const url = isEditMode ? `/admin/edit_vehicle/${currentVehicleId}` : '/admin/add_vehicle';

    console.log('Submitting to:', url);
    console.log('Is edit mode:', isEditMode);

    showLoading();

    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        hideLoading();
        if (data.success) {
            showToast(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('vehicleModal'));
            modal.hide();

            // Reload page to refresh data and clear cache
            setTimeout(() => {
                // Add cache busting parameter
                window.location.href = window.location.href.split('?')[0] + '?refresh=' + Date.now();
            }, 1000);
        } else {
            if (data.errors) {
                console.log('Form validation errors:', data.errors);
                showFormErrors(data.errors);
            } else {
                showToast(data.message, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Form submission error:', error);
        hideLoading();
        showToast('Error submitting form: ' + error.message, 'danger');
    });
});

// Enhanced Tab Navigation
const tabs = ['basic', 'engine', 'ownership', 'insurance', 'features', 'contact'];
const tabButtons = ['basic-tab', 'engine-tab', 'ownership-tab', 'insurance-tab', 'features-tab', 'contact-tab'];

function resetToFirstTab() {
    currentTabIndex = 0;
    const firstTabButton = document.getElementById('basic-tab');
    if (firstTabButton) {
        firstTabButton.click();
    } else {
        console.warn('Basic tab button not found during reset.');
    }
}

function updateProgressIndicator(activeIndex) {
    const indicators = document.querySelectorAll('.step-indicator');

    indicators.forEach((indicator, index) => {
        const stepContainer = indicator.parentNode;
        const stepNumber = stepContainer.querySelector('.small.fw-bold, .small.text-muted:first-of-type');
        const stepLabel = stepContainer.querySelector('.small.text-muted:last-child');

        if (index <= activeIndex) {
            // Completed or current step
            indicator.className = 'step-indicator bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center';
            indicator.style.cssText = 'width: 40px; height: 40px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,123,255,0.3);';

            if (stepNumber) {
                stepNumber.className = 'mt-2 small fw-bold text-primary';
            }
            if (stepLabel) {
                stepLabel.className = 'small text-primary';
            }

            // Add checkmark for completed steps
            if (index < activeIndex) {
                indicator.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                // Current step - show original icon
                const icons = ['fas fa-info-circle', 'fas fa-cog', 'fas fa-history', 'fas fa-shield-alt', 'fas fa-star', 'fas fa-check'];
                indicator.innerHTML = `<i class="${icons[index]}"></i>`;
            }
        } else {
            // Future steps
            indicator.className = 'step-indicator bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center';
            indicator.style.cssText = 'width: 40px; height: 40px; border: 3px solid white;';

            if (stepNumber) {
                stepNumber.className = 'mt-2 small text-muted';
            }
            if (stepLabel) {
                stepLabel.className = 'small text-muted';
            }

            // Show original icon for future steps
            const icons = ['fas fa-info-circle', 'fas fa-cog', 'fas fa-history', 'fas fa-shield-alt', 'fas fa-star', 'fas fa-check'];
            indicator.innerHTML = `<i class="${icons[index]}"></i>`;
        }
    });

    // Update progress line
    const progressLine = document.getElementById('progress-line');
    if (progressLine) {
        const progressPercentage = (activeIndex / (tabs.length - 1)) * 100;
        progressLine.style.width = `${progressPercentage}%`;
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-tab-btn');
    const nextBtn = document.getElementById('next-tab-btn');
    const submitBtn = document.getElementById('submit-btn');
    const stepCounter = document.getElementById('step-counter');

    // Update step counter
    if (stepCounter) {
        stepCounter.textContent = `Step ${currentTabIndex + 1} of ${tabs.length}`;
    }

    // Show/hide previous button
    if (prevBtn) {
        prevBtn.style.display = currentTabIndex > 0 ? 'inline-block' : 'none';
    }

    // Update button text based on current step
    const stepNames = ['Basic Info', 'Engine Details', 'Vehicle History', 'Insurance Info', 'Features', 'Images & Finish'];

    if (currentTabIndex === tabs.length - 1) {
        // Last step - show save button
        if (nextBtn) nextBtn.style.display = 'none';
        if (submitBtn) submitBtn.style.display = 'inline-block';
        if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Vehicle';
        if (stepCounter) {
            stepCounter.className = 'badge bg-success px-3 py-2';
            stepCounter.textContent = 'Ready to Save!';
        }
    } else {
        // Show next button with step name
        if (nextBtn) nextBtn.style.display = 'inline-block';
        if (submitBtn) submitBtn.style.display = 'none';
        if (nextBtn) nextBtn.innerHTML = `Continue to ${stepNames[currentTabIndex + 1]} <i class="fas fa-arrow-right ms-1"></i>`;
        if (stepCounter) {
            stepCounter.className = 'badge bg-primary px-3 py-2';
        }
    }
}

// Enhanced Navigation with validation
document.getElementById('next-tab-btn').addEventListener('click', function() {
    // Validate current step before proceeding
    if (validateCurrentStep()) {
        if (currentTabIndex < tabs.length - 1) {
            currentTabIndex++;
            const nextTabButton = document.getElementById(tabButtons[currentTabIndex]);
            if (nextTabButton) {
                nextTabButton.click();
            } else {
                console.warn(`Next tab button not found for index ${currentTabIndex}`);
            }
            updateProgressIndicator(currentTabIndex);
            updateNavigationButtons();

            // Smooth scroll to top of modal content
            document.querySelector('.modal-body').scrollTop = 0;

            // Add a subtle animation
            const activeTab = document.querySelector('.tab-pane.active');
            if (activeTab) {
                activeTab.style.opacity = '0';
                setTimeout(() => {
                    activeTab.style.opacity = '1';
                    activeTab.style.transition = 'opacity 0.3s ease';
                }, 50);
            }
        }
    }
});

document.getElementById('prev-tab-btn').addEventListener('click', function() {
    if (currentTabIndex > 0) {
        currentTabIndex--;
        const prevTabButton = document.getElementById(tabButtons[currentTabIndex]);
        if (prevTabButton) {
            prevTabButton.click();
        } else {
            console.warn(`Previous tab button not found for index ${currentTabIndex}`);
        }
        updateProgressIndicator(currentTabIndex);
        updateNavigationButtons();

        // Smooth scroll to top of modal content
        document.querySelector('.modal-body').scrollTop = 0;
    }
});

// Validation function for current step
function validateCurrentStep() {
    clearFormErrors();

    if (currentTabIndex === 0) {
        // Basic Info validation
        const title = document.getElementById('modal-title').value.trim();
        const make = document.getElementById('modal-make').value.trim();
        const model = document.getElementById('modal-model').value.trim();
        const year = document.getElementById('modal-year').value;
        const price = document.getElementById('modal-price').value;
        const mileage = document.getElementById('modal-mileage').value;
        const contactName = document.getElementById('modal-contact-name').value.trim();
        const contactPhone = document.getElementById('modal-contact-phone').value.trim();

        const basicRequiredFields = [
            { id: 'modal-title', name: 'Vehicle Title' },
            { id: 'modal-make', name: 'Make' },
            { id: 'modal-model', name: 'Model' },
            { id: 'modal-year', name: 'Year' },
            { id: 'modal-price', name: 'Price' },
            { id: 'modal-mileage', name: 'Mileage' },
            { id: 'modal-contact-name', name: 'Contact Name' },
            { id: 'modal-contact-phone', name: 'Contact Phone' }
        ];

        const missingBasicFields = [];

        basicRequiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                const value = element.value.trim();
                if (!value || value === '') {
                    missingBasicFields.push(field.name);
                    element.classList.add('is-invalid');
                }
            }
        });

        if (missingBasicFields.length > 0) {
            const fieldsList = missingBasicFields.join(', ');
            showToast(`Missing required fields: ${fieldsList}`, 'warning');
            return false;
        }
    }

    // Add validation for other steps if needed
    // Example for Engine step (optional fields, but good to check required dropdowns)
    if (currentTabIndex === 1) {
        const fuelType = document.getElementById('modal-fuel-type').value;
        const transmission = document.getElementById('modal-transmission').value;

        if (!fuelType) {
            document.getElementById('modal-fuel-type').classList.add('is-invalid');
            showToast('Please select a fuel type.', 'warning');
            return false;
        }
        if (!transmission) {
            document.getElementById('modal-transmission').classList.add('is-invalid');
            showToast('Please select a transmission type.', 'warning');
            return false;
        }
    }

    return true;
}

// Tab click event listeners
tabButtons.forEach((tabId, index) => {
    const tabElement = document.getElementById(tabId);
    if (tabElement) {
        tabElement.addEventListener('click', function() {
            currentTabIndex = index;
            updateProgressIndicator(currentTabIndex);
            updateNavigationButtons();
        });
    }
});

// Enhanced image upload UI
function initializeImageSlots() {
    for (let i = 1; i <= 6; i++) {
        const slot = document.getElementById(`image-slot-${i}`);
        if (!slot) continue;

        const slotContent = slot.querySelector('.slot-content');
        if (!slotContent) continue;

        // Only initialize if content is empty
        if (!slotContent.innerHTML.trim()) {
            slotContent.innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-2"></i>
                <p class="mb-1 fw-bold">Click to upload</p>
                <small class="text-muted">or drag and drop image here</small>
                <small class="d-block text-muted mt-1">Max 5MB • JPG, PNG, GIF</small>
            `;
        }

        // Add drag and drop functionality with proper error handling
        slot.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadSlot = this.querySelector('.image-upload-slot');
            if (uploadSlot) {
                uploadSlot.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
            }
        });

        slot.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadSlot = this.querySelector('.image-upload-slot');
            // Check if the mouse is still within the bounds of the slot before resetting
            const relatedTarget = e.relatedTarget;
            if (!uploadSlot.contains(relatedTarget)) {
                uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            }
        });

        slot.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadSlot = this.querySelector('.image-upload-slot');
            if (uploadSlot) {
                uploadSlot.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            }

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const input = document.getElementById(`image-input-${i}`);
                if (input) {
                    try {
                        // Simulate file input change
                        input.files = files;
                        handleImageUpload(i, input);
                    } catch (error) {
                        console.error('Error handling dropped file:', error);
                        showToast('Error handling dropped file', 'danger');
                    }
                }
            }
        });
    }
}

// Reset form when modal is hidden
document.getElementById('vehicleModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('vehicleForm').reset();
    clearFormErrors();
    resetToFirstTab(); // Reset tab index and click the first tab
    updateProgressIndicator(0); // Ensure progress is reset
    updateNavigationButtons(); // Update navigation buttons for the first tab
});

// Initialize enhanced UI when modal is shown
document.getElementById('vehicleModal').addEventListener('shown.bs.modal', function() {
    initializeImageSlots(); // Ensure image slots are ready
});

// Add initializations on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Auto Dealership app loaded successfully');

    // Initialize all components with null checks
    initializeAdminInterface();

    // Initialize image slots when page loads
    const modal = document.getElementById('vehicleModal');
    if (modal) {
        initializeImageSlots();
    }

    // Update statistics on page load
    updateStatistics();

    // Initialize tab navigation listeners
    updateTabNavigation();

    // Setup initial state for navigation buttons and progress
    updateProgressIndicator(currentTabIndex);
    updateNavigationButtons();
});

function initializeAdminInterface() {
    try {
        // Check if all required elements exist
        const requiredElements = [
            'vehicleModal',
            'vehicleForm',
            'vehicles-table',
            'total-count',
            'available-count',
            'sold-count'
        ];

        requiredElements.forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Required element '${id}' not found.`);
            }
        });

        // Initialize image slots content if they are empty
        for (let i = 1; i <= 6; i++) {
            const slot = document.getElementById(`image-slot-${i}`);
            if (!slot) {
                console.warn(`Image slot ${i} not found.`);
                continue;
            }

            const slotContent = slot.querySelector('.slot-content');
            if (slotContent && !slotContent.innerHTML.trim()) {
                slotContent.innerHTML = `
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-2"></i>
                    <p class="mb-1 fw-bold">Click to upload</p>
                    <small class="text-muted">or drag and drop image here</small>
                    <small class="d-block text-muted mt-1">Max 5MB • JPG, PNG, GIF</small>
                `;
            }
        }

    } catch (error) {
        console.error('Error during admin interface initialization:', error);
    }
}

// Auto-format price input
const priceInput = document.getElementById('modal-price');
if (priceInput) {
    priceInput.addEventListener('input', function() {
        let value = this.value.replace(/[^\d.]/g, '');
        if (value.includes('.')) {
            const parts = value.split('.');
            value = parts[0] + '.' + parts[1].substring(0, 2); // Limit to 2 decimal places
        }
        this.value = value;
    });
}

// Auto-format mileage input
const mileageInput = document.getElementById('modal-mileage');
if (mileageInput) {
    mileageInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^\d]/g, ''); // Only allow digits
    });
}
</script>
{% endblock %}