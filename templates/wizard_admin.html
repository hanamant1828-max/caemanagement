{% extends "base.html" %}

{% block title %}Vehicle Management - AutoMarket{% endblock %}

{% block content %}
<style>
/* Step-by-Step Wizard Styling */
.wizard-container {
    max-width: 800px;
    margin: 0 auto;
}

.step-indicators {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.step-indicators::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step-item {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
    cursor: pointer;
    transition: all 0.3s ease;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    transition: all 0.3s ease;
    font-size: 1.1rem;
}

.step-item.active .step-circle {
    background: #007bff;
    color: white;
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
}

.step-item.completed .step-circle {
    background: #28a745;
    color: white;
}

.step-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

.step-item.active .step-label {
    color: #007bff;
    font-weight: 600;
}

.step-item.completed .step-label {
    color: #28a745;
}

.step-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    min-height: 400px;
}

.step-pane {
    display: none;
}

.step-pane.active {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.step-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f8f9fa;
}

.step-title {
    color: #007bff;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.step-description {
    color: #6c757d;
    font-size: 1rem;
}

.wizard-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.btn-wizard {
    min-width: 120px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    border-radius: 8px;
}

.form-control, .form-select {
    color: #212529 !important;
    background-color: #ffffff !important;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
    color: #212529 !important;
    background-color: #ffffff !important;
}

.form-label {
    color: #212529 !important;
    font-weight: 600 !important;
    margin-bottom: 0.5rem;
}

.required-indicator {
    color: #dc3545;
    margin-left: 3px;
}

.field-help {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.progress-bar-custom {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 2rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    transition: width 0.3s ease;
    border-radius: 3px;
}

.summary-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.summary-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.image-upload-area {
    border: 2px dashed #007bff;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.image-upload-area:hover {
    background: #e3f2fd;
    border-color: #0056b3;
}

.image-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.image-preview-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.image-preview-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.image-remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}

.navigation-info {
    color: #6c757d;
    font-size: 0.875rem;
    text-align: center;
    margin-top: 1rem;
}

@media (max-width: 768px) {
    .step-indicators {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .step-item {
        flex: 1 1 calc(33.333% - 1rem);
        min-width: 100px;
    }
    
    .wizard-navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .step-content {
        padding: 1.5rem;
    }
}

/* Dashboard styling */
.dashboard-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.stats-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: none;
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.vehicle-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
</style>

<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="dashboard-header p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Vehicle Management Dashboard
                </h1>
                <p class="mb-0 opacity-75">Add and manage your vehicle inventory with our step-by-step wizard</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button type="button" class="btn btn-light btn-lg" onclick="openWizard()">
                    <i class="fas fa-plus me-2"></i>Add New Vehicle
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-car fa-2x text-primary mb-2"></i>
                    <h3 class="text-primary mb-1">{{ vehicles|length }}</h3>
                    <h6 class="text-muted mb-0">Total Vehicles</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h3 class="text-success mb-1">{{ vehicles|selectattr("status", "equalto", "available")|list|length }}</h3>
                    <h6 class="text-muted mb-0">Available</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-handshake fa-2x text-warning mb-2"></i>
                    <h3 class="text-warning mb-1">{{ vehicles|selectattr("status", "equalto", "sold")|list|length }}</h3>
                    <h6 class="text-muted mb-0">Sold</h6>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x text-info mb-2"></i>
                    <h3 class="text-info mb-1">${{ "{:,.0f}".format((vehicles|selectattr("status", "equalto", "available")|map(attribute="price")|sum)/1000) }}K</h3>
                    <h6 class="text-muted mb-0">Inventory Value</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicles Table -->
    <div class="vehicle-table">
        <div class="card-header bg-white border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2 text-primary"></i>Vehicle Inventory
                    </h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search vehicles..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="vehiclesTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Vehicle Details</th>
                        <th>Price</th>
                        <th>Mileage</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr>
                        <td>
                            {% if vehicle.images_list %}
                                <img src="{{ url_for('static', filename='uploads/' + vehicle.images_list[0]) }}" 
                                     class="rounded" style="width: 60px; height: 45px; object-fit: cover;" 
                                     alt="{{ vehicle.title }}">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center text-muted" 
                                     style="width: 60px; height: 45px;">
                                    <i class="fas fa-car"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <h6 class="mb-1">{{ vehicle.title }}</h6>
                                <small class="text-muted">{{ vehicle.year }} • {{ vehicle.make }} {{ vehicle.model }}</small>
                            </div>
                        </td>
                        <td>
                            <strong class="text-success">${{ "{:,.0f}".format(vehicle.price) }}</strong>
                        </td>
                        <td>
                            {{ "{:,}".format(vehicle.mileage) }} mi
                        </td>
                        <td>
                            {% if vehicle.status == 'available' %}
                                <span class="badge bg-success">Available</span>
                            {% else %}
                                <span class="badge bg-secondary">Sold</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="viewVehicle('{{ vehicle.id }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="editVehicle('{{ vehicle.id }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteVehicle('{{ vehicle.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Step-by-Step Vehicle Wizard Modal -->
<div class="modal fade" id="vehicleWizard" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Add Vehicle - Step by Step
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-0">
                <div class="wizard-container p-4">
                    <!-- Progress Bar -->
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="progressFill" style="width: 16.67%;"></div>
                    </div>
                    
                    <!-- Step Indicators -->
                    <div class="step-indicators">
                        <div class="step-item active" data-step="1">
                            <div class="step-circle">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="step-label">Basic Info</div>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="step-circle">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="step-label">Engine</div>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="step-circle">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="step-label">History</div>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="step-circle">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="step-label">Documents</div>
                        </div>
                        <div class="step-item" data-step="5">
                            <div class="step-circle">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="step-label">Features</div>
                        </div>
                        <div class="step-item" data-step="6">
                            <div class="step-circle">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="step-label">Photos</div>
                        </div>
                    </div>

                    <form id="vehicleWizardForm" method="POST" enctype="multipart/form-data" action="/admin/add_vehicle">
                        {{ form.hidden_tag() }}
                        
                        <!-- Step 1: Basic Information -->
                        <div class="step-content">
                            <div class="step-pane active" id="step1">
                                <div class="step-header">
                                    <h3 class="step-title">Basic Vehicle Information</h3>
                                    <p class="step-description">Let's start with the essential details about your vehicle</p>
                                </div>
                                
                                <div class="row g-4">
                                    <div class="col-12">
                                        <label class="form-label">Vehicle Title<span class="required-indicator">*</span></label>
                                        {{ form.title(class="form-control form-control-lg", placeholder="e.g., 2020 Honda Civic LX - Excellent Condition", required=true) }}
                                        <div class="field-help">Create an attractive title that highlights key features</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Category<span class="required-indicator">*</span></label>
                                        {{ form.category(class="form-select form-select-lg", required=true) }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Year<span class="required-indicator">*</span></label>
                                        {{ form.year(class="form-control", placeholder="e.g., 2020", required=true) }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Make<span class="required-indicator">*</span></label>
                                        {{ form.make(class="form-control", placeholder="e.g., Honda", required=true) }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Model<span class="required-indicator">*</span></label>
                                        {{ form.model(class="form-control", placeholder="e.g., Civic", required=true) }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Price<span class="required-indicator">*</span></label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text">$</span>
                                            {{ form.price(class="form-control", placeholder="25000", required=true) }}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Mileage<span class="required-indicator">*</span></label>
                                        <div class="input-group input-group-lg">
                                            {{ form.mileage(class="form-control", placeholder="50000", required=true) }}
                                            <span class="input-group-text">miles</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <label class="form-label">Description</label>
                                        {{ form.description(class="form-control", rows="4", placeholder="Describe the vehicle's condition, features, and any important details...") }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Engine & Performance -->
                            <div class="step-pane" id="step2">
                                <div class="step-header">
                                    <h3 class="step-title">Engine & Performance</h3>
                                    <p class="step-description">Technical specifications and performance details</p>
                                </div>
                                
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Fuel Type</label>
                                        {{ form.fuel_type(class="form-select") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Transmission</label>
                                        {{ form.transmission(class="form-select") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Engine Size</label>
                                        {{ form.engine_size(class="form-control", placeholder="e.g., 2.0L") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Horsepower</label>
                                        {{ form.horsepower(class="form-control", placeholder="e.g., 180") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Drivetrain</label>
                                        {{ form.drivetrain(class="form-select") }}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label class="form-label">Fuel Economy</label>
                                        {{ form.fuel_economy(class="form-control", placeholder="e.g., 25 city / 32 highway mpg") }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Ownership & History -->
                            <div class="step-pane" id="step3">
                                <div class="step-header">
                                    <h3 class="step-title">Ownership & History</h3>
                                    <p class="step-description">Previous ownership and vehicle history information</p>
                                </div>
                                
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Number of Previous Owners</label>
                                        {{ form.number_of_owners(class="form-control", placeholder="e.g., 1") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Odometer Reading</label>
                                        {{ form.odometer_reading(class="form-control", placeholder="Current mileage") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Previous Owner Name</label>
                                        {{ form.previous_owner_name(class="form-control", placeholder="Owner name") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Previous Owner Phone</label>
                                        {{ form.previous_owner_phone(class="form-control", placeholder="(555) 123-4567") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Previous Owner Email</label>
                                        {{ form.previous_owner_email(class="form-control", placeholder="owner@email.com") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Accident History</label>
                                        {{ form.accident_history(class="form-control", rows="3", placeholder="Any accident history or damage reports...") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Service Records</label>
                                        {{ form.service_records(class="form-control", rows="3", placeholder="Maintenance and service records...") }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 4: Insurance & Documentation -->
                            <div class="step-pane" id="step4">
                                <div class="step-header">
                                    <h3 class="step-title">Insurance & Documentation</h3>
                                    <p class="step-description">Legal documents and insurance information</p>
                                </div>
                                
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Insurance Company</label>
                                        {{ form.insurance_company(class="form-control", placeholder="e.g., State Farm") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Policy Number</label>
                                        {{ form.insurance_policy_number(class="form-control", placeholder="Policy number") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Insurance Expiry</label>
                                        {{ form.insurance_expiry(class="form-control", placeholder="MM/DD/YYYY") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Registration Number</label>
                                        {{ form.registration_number(class="form-control", placeholder="Registration number") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">VIN Number</label>
                                        {{ form.vin_number(class="form-control", placeholder="17-character VIN", maxlength="17") }}
                                        <div class="field-help">Vehicle Identification Number (exactly 17 characters)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 5: Features & Condition -->
                            <div class="step-pane" id="step5">
                                <div class="step-header">
                                    <h3 class="step-title">Features & Condition</h3>
                                    <p class="step-description">Vehicle features, colors, and condition details</p>
                                </div>
                                
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Exterior Color</label>
                                        {{ form.exterior_color(class="form-control", placeholder="e.g., Blue") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Interior Color</label>
                                        {{ form.interior_color(class="form-control", placeholder="e.g., Black") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Condition Rating</label>
                                        {{ form.condition_rating(class="form-select") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Features</label>
                                        {{ form.features(class="form-control", rows="3", placeholder="List features separated by commas (e.g., Sunroof, Leather seats, Navigation...)") }}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">Warranty Information</label>
                                        {{ form.warranty_info(class="form-control", rows="3", placeholder="Warranty information and coverage details...") }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Contact Name<span class="required-indicator">*</span></label>
                                        {{ form.contact_name(class="form-control", placeholder="Contact person", required=true) }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Contact Phone<span class="required-indicator">*</span></label>
                                        {{ form.contact_phone(class="form-control", placeholder="(555) 123-4567", required=true) }}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Contact Email</label>
                                        {{ form.contact_email(class="form-control", placeholder="contact@email.com") }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 6: Photos & Finish -->
                            <div class="step-pane" id="step6">
                                <div class="step-header">
                                    <h3 class="step-title">Photos & Final Review</h3>
                                    <p class="step-description">Add photos and review your vehicle listing</p>
                                </div>
                                
                                <div class="row g-4">
                                    <div class="col-12">
                                        <label class="form-label">Vehicle Images (Max 6)</label>
                                        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                            <h5>Add Vehicle Photos</h5>
                                            <p class="text-muted">Click here to select up to 6 images</p>
                                            <input type="file" id="imageInput" name="images" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                                            <button type="button" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i>Choose Images
                                            </button>
                                            <div class="field-help">Accepted formats: JPG, PNG, GIF (Max 6 images, 16MB each)</div>
                                        </div>
                                        <div class="image-preview-grid" id="imagePreviewGrid"></div>
                                        <div id="imageCount" class="text-center mt-2 text-muted">0 / 6 images selected</div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="summary-section">
                                            <h6 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Vehicle Summary</h6>
                                            <div id="vehicleSummary">
                                                <!-- Summary will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <div class="wizard-navigation">
                            <button type="button" class="btn btn-secondary btn-wizard" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            
                            <div class="navigation-info">
                                Step <span id="currentStepNum">1</span> of 6
                            </div>
                            
                            <button type="button" class="btn btn-primary btn-wizard" id="nextBtn" onclick="changeStep(1)">
                                Next<i class="fas fa-arrow-right ms-2"></i>
                            </button>
                            
                            <button type="submit" class="btn btn-success btn-wizard" id="submitBtn" style="display: none;">
                                <i class="fas fa-save me-2"></i>Save Vehicle
                            </button>
                            
                            <button type="button" class="btn btn-info btn-wizard" onclick="testAlert()" style="display: none;" id="testBtn">
                                <i class="fas fa-bell me-2"></i>Test Alert
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 6;

function openWizard() {
    currentStep = 1;
    updateWizardDisplay();
    new bootstrap.Modal(document.getElementById('vehicleWizard')).show();
}

function changeStep(direction) {
    if (direction === 1 && currentStep < totalSteps) {
        if (validateCurrentStep()) {
            currentStep++;
        }
    } else if (direction === -1 && currentStep > 1) {
        currentStep--;
    }
    
    updateWizardDisplay();
}

function updateWizardDisplay() {
    // Update progress bar
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    
    // Update step indicators
    document.querySelectorAll('.step-item').forEach((item, index) => {
        const stepNum = index + 1;
        item.classList.toggle('active', stepNum === currentStep);
        item.classList.toggle('completed', stepNum < currentStep);
    });
    
    // Update step panes
    document.querySelectorAll('.step-pane').forEach((pane, index) => {
        pane.classList.toggle('active', index + 1 === currentStep);
    });
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'block';
    document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';
    document.getElementById('testBtn').style.display = currentStep === totalSteps ? 'block' : 'none';
    
    // Update step counter
    document.getElementById('currentStepNum').textContent = currentStep;
    
    // Update summary on last step
    if (currentStep === totalSteps) {
        updateVehicleSummary();
    }
}

function validateCurrentStep() {
    const currentPane = document.getElementById(`step${currentStep}`);
    let isValid = true;
    
    // Check required fields based on current step
    if (currentStep === 1) {
        const requiredFields = ['title', 'category', 'year', 'make', 'model', 'price', 'mileage'];
        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        });
    } else if (currentStep === 5) {
        const requiredFields = ['contact_name', 'contact_phone'];
        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        });
    }
    
    if (!isValid) {
        showAlert('Please fill in all required fields before proceeding to the next step.', 'warning');
    }
    
    return isValid;
}

function showAlert(message, type = 'info') {
    // Remove any existing alerts first
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-relative`;
    alertDiv.style.cssText = 'z-index: 9999; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 500;';
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    const container = document.querySelector('.wizard-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 8 seconds for success, 10 seconds for errors
    const timeout = type === 'success' ? 8000 : 10000;
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, timeout);
    
    // Scroll to top to ensure alert is visible
    container.scrollTop = 0;
}

function updateVehicleSummary() {
    const form = document.getElementById('vehicleWizardForm');
    const formData = new FormData(form);
    const summary = document.getElementById('vehicleSummary');
    
    const summaryData = [
        { label: 'Vehicle Title', value: formData.get('title') || 'Not specified' },
        { label: 'Year', value: formData.get('year') || 'Not specified' },
        { label: 'Make & Model', value: `${formData.get('make') || ''} ${formData.get('model') || ''}`.trim() || 'Not specified' },
        { label: 'Category', value: formData.get('category') || 'Not specified' },
        { label: 'Price', value: formData.get('price') ? `$${parseInt(formData.get('price')).toLocaleString()}` : 'Not specified' },
        { label: 'Mileage', value: formData.get('mileage') ? `${parseInt(formData.get('mileage')).toLocaleString()} miles` : 'Not specified' },
        { label: 'Fuel Type', value: formData.get('fuel_type') || 'Not specified' },
        { label: 'Transmission', value: formData.get('transmission') || 'Not specified' },
        { label: 'Contact Person', value: formData.get('contact_name') || 'Not specified' },
        { label: 'Contact Phone', value: formData.get('contact_phone') || 'Not specified' },
        { label: 'Images', value: `${selectedFiles.length} image(s) selected` }
    ];
    
    summary.innerHTML = summaryData.map(item => 
        `<div class="summary-item">
            <strong>${item.label}:</strong>
            <span>${item.value}</span>
        </div>`
    ).join('');
}

// Image preview functionality
let selectedFiles = [];

function handleImageUpload(input) {
    const files = Array.from(input.files);
    const maxFiles = 6;
    
    if (files.length > maxFiles) {
        showAlert(`You can only select up to ${maxFiles} images. Only the first ${maxFiles} will be used.`, 'warning');
    }
    
    selectedFiles = files.slice(0, maxFiles);
    updateImagePreview();
}

function updateImagePreview() {
    const grid = document.getElementById('imagePreviewGrid');
    const counter = document.getElementById('imageCount');
    grid.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                item.innerHTML = `
                    <img src="${e.target.result}" alt="Preview ${index + 1}">
                    <button type="button" class="image-remove-btn" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                grid.appendChild(item);
            };
            reader.readAsDataURL(file);
        }
    });
    
    counter.textContent = `${selectedFiles.length} / 6 images selected`;
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    updateImagePreview();
    
    // Update the input files
    const input = document.getElementById('imageInput');
    const dt = new DataTransfer();
    selectedFiles.forEach(file => dt.items.add(file));
    input.files = dt.files;
}

// Form submission
document.getElementById('vehicleWizardForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate all required fields
    if (!validateCurrentStep()) {
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving Vehicle...';
    
    // Create FormData with all form fields
    const formData = new FormData(this);
    
    // Clear previous images and add selected images
    formData.delete('images');
    selectedFiles.forEach(file => {
        formData.append('images', file);
    });
    
    console.log('Submitting form data...');
    
    // Submit via fetch with better error handling
    fetch('/admin/add_vehicle', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json().then(data => ({
            status: response.status,
            data: data
        }));
    })
    .then(({status, data}) => {
        console.log('Response data:', data);
        
        if (status === 200 && data.success) {
            showAlert('✅ Vehicle added successfully! The page will refresh shortly.', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(data.message || 'Failed to save vehicle');
        }
    })
    .catch(error => {
        console.error('Error details:', error);
        showAlert('❌ Error saving vehicle: ' + error.message + '. Please check all required fields and try again.', 'danger');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Vehicle';
    });
});

// Auto-populate title
function autoPopulateTitle() {
    const year = document.querySelector('[name=year]').value;
    const make = document.querySelector('[name=make]').value;
    const model = document.querySelector('[name=model]').value;
    const title = document.querySelector('[name=title]');
    
    if (year && make && model && !title.value) {
        title.value = `${year} ${make} ${model}`;
    }
}

document.querySelector('[name=year]').addEventListener('blur', autoPopulateTitle);
document.querySelector('[name=make]').addEventListener('blur', autoPopulateTitle);
document.querySelector('[name=model]').addEventListener('blur', autoPopulateTitle);

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#vehiclesTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Vehicle actions
function viewVehicle(id) {
    window.open(`/vehicle/${id}`, '_blank');
}

function editVehicle(id) {
    // Open wizard in edit mode
    openWizard();
    // Load vehicle data - would need backend endpoint
}

function deleteVehicle(id) {
    if (confirm('Are you sure you want to delete this vehicle?')) {
        // Handle deletion
        fetch(`/admin/delete_vehicle/${id}`, { method: 'DELETE' })
        .then(() => location.reload());
    }
}

// Test alert function
function testAlert() {
    showAlert('🔔 This is a test notification! The alert system is working properly.', 'info');
}
</script>
{% endblock %}